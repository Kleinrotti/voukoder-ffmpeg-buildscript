name: X265

on:
  workflow_dispatch:
    inputs:
      config:
        description: 'Configuration'     
        required: true
        default: 'Debug'
     
env:
  vsPath: C:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise\
  msysConfig: debug
  winConfig: Debug
  cFlags: -MDd
  switches: "--enable-encoder=libvpl --enable-encoder=libsvtav1 --enable-encoder=libsnappy --enable-encoder=libvpx --enable-encoder=libmp3lame --enable-encoder=libzimg --enable-encoder=libopus --enable-encoder=libogg --enable-encoder=libvorbis --enable-encoder=libx264"

  
jobs:

  x265-12:
    runs-on: windows-2019
    steps:
    - name: Checkout X265
      shell: cmd
      run: |
        git config --global core.autocrlf false
        git config --global core.eol lf
        git clone -b Release_3.5 https://github.com/videolan/x265.git x265
    - name: Set up NASM
      uses: ilammy/setup-nasm@v1.2.1
    - name: Build X265 (12 bit)
      shell: cmd
      run: |
        call "${{ env.vsPath }}VC\Auxiliary\Build\vcvars64.bat"
        md build dist
        cd x265/build/vc15-x86_64
        md work12
        cd work12
        cmake -G "Visual Studio 16 2019" ..\..\..\source -DHIGH_BIT_DEPTH=ON -DEXPORT_C_API=OFF -DENABLE_SHARED=OFF -DENABLE_CLI=OFF -DMAIN12=ON
        MSBuild.exe /property:Configuration="${{ env.winConfig }}" x265-static.vcxproj
        move ${{ env.winConfig }}/x265-static.lib dist/x265_12bit.lib
    - name: Publish artifact
      uses: actions/upload-artifact@v2
      with:
        name: x265_12bit
        path: dist/x265_12bit.tgz
